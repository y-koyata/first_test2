# イベント申し込み管理システム 仕様書

## 1. プロジェクト概要
- **プロジェクト名**: イベント申し込み管理サイト構築
- **バージョン**: 1.0 (Final)
- **作成日**: 2026/01/11
- **インフラ**: ロリポップ！レンタルサーバー（ビジネスプラン）

### 概要
一般公開されるイベントの申し込みを受け付けるWebシステム。毎年開催されるキャンペーンに対応し、**「個人情報の保護」と「不正登録の排除」**を最優先事項とする。申し込みはメールアドレスによる本人確認（ダブルオプトイン）を必須とし、既存データの変更時も個人情報を画面に表示しない「上書き方式」を採用する。

## 2. システム環境・インフラ構成

| 項目 | 内容 | 備考 |
|:---|:---|:---|
| サーバー | ロリポップ！レンタルサーバー | プラン：ビジネス（またはスタンダード以上） |
| Webサーバー | Apache | .htaccess 利用可能 |
| フレームワーク | Laravel 10.x または 11.x | PHP 8.2以上必須 |
| データベース | MariaDB (MySQL互換) | |
| SSL | 独自SSL（無料） | 常時HTTPS化必須 |
| WAF | 有効化 | 管理画面操作時は除外設定が必要な場合あり |

### 2.1 ディレクトリ構成（セキュリティ分離）
Web公開領域（public_html）にはプログラム本体を置かず、非公開領域から参照させる構成とする。

```text
/home/users/xxx/  (FTPルート・非公開)
 ├── laravel_project/        <-- Laravel本体一式 (.env含む)
 └── web/                    <-- 公開エリア (public_html)
      ├── index.php           <-- 本体へのパスを通したエントリーポイント
      ├── assets/             <-- CSS, JS, 画像など
      └── admin/              <-- ダミーディレクトリ（Basic認証設定用）
```

## 3. データベース設計

### 3.1 reservations (申し込み情報)
複合ユニーク制約: `campaign_id` + `email`（同一キャンペーン内でのメールアドレス重複は禁止。別キャンペーンであれば許可）

| カラム名 | 型 | 説明 |
|:---|:---|:---|
| id | BIGINT | プライマリキー |
| campaign_id | INT | キャンペーン識別ID |
| email | STRING | メールアドレス（連絡用・兼ID） |
| name | STRING | 氏名（漢字） |
| name_kana | STRING | 氏名（フリガナ） |
| gender | TINYINT | 性別（1:男, 2:女） |
| birth_date | DATE | 生年月日 |
| zip_code | STRING | 郵便番号 |
| address | STRING | 住所 |
| tel | STRING | 電話番号（数値のみ） |
| mtb_experience | STRING | 参加経験（owner, passenger, none） |
| club_name | STRING | 所属クラブ名称 |
| club_base | STRING | 所属クラブ活動拠点 |
| club_role | STRING | 所属クラブでの役割（member, organizer, rep） |
| car_model | STRING | 車種（beat, ver_f, ver_c, ver_z, other） |
| car_year | STRING | 年式（1991-1996） |
| car_color | STRING | 車体色 |
| car_color_other | STRING | 車体色（その他の場合） |
| car_registration_no | STRING | 登録No.（ナンバープレート） |
| companion_adult_count | INT | 同伴者人数（高校生以上） |
| companion_child_count | INT | 同伴者人数（中学生以下） |
| additional_parking_count | INT | 駐車台数（追加分） |
| transfer_date | DATE | 振込予定日 |
| application_date | DATE | 申込日 |
| total_amount | INT | 合計金額（自動計算） |
| status | STRING | temporary(仮), pending(未入金), paid(入金済) |
| email_verified_at | DATETIME | メール認証完了日時 |
| created_at | DATETIME | 作成日時 |
| updated_at | DATETIME | 更新日時 |

### 3.2 cancellation_logs (キャンセルログ)
物理削除時の証跡。個人情報はメールアドレスのみ残す。

| カラム名 | 型 | 説明 |
|:---|:---|:---|
| id | BIGINT | プライマリキー |
| campaign_id | INT | キャンペーンID |
| email | STRING | 削除されたメールアドレス |
| canceled_at | DATETIME | 削除実行日時 |

## 4. 機能要件（フロントエンド）

### 4.1 新規申し込みフロー
1. **入力フォーム**: 取得項目は後述。
2. **reCAPTCHA**: スパム対策として導入必須。
3. **重複チェック**: 入力された email が現在の `campaign_id` で登録済みか判定。
   - **未登録の場合**: 仮登録処理へ。
   - **登録済みの場合**: 「登録内容変更のお知らせ」メールを送信。
4. **仮登録**: ステータス `temporary` でDB保存。署名付きURL (Signed URL) を生成し、認証メールを自動送信（有効期限: 30分目安）。
5. **本登録**: URLクリックで認証完了。ステータスを `pending`（未入金）へ更新。完了画面に振込先口座情報を表示。

### 4.2 入力フォーム項目詳細

#### ① お申込者情報
- **氏名（漢字）**: 自由記述
- **氏名（フリガナ）**: 自由記述
- **性別**: 選択式（男、女）
- **生年月日**: 日付選択
- **郵便番号**: 自由記述（住所自動入力連携推奨）
- **住所**: 自由記述
- **電話番号**: 自由記述（数値のみ）
- **M.T.B! 参加経験**: 選択式（オーナー参加あり、同乗参加あり、無し）
- **所属クラブ名称**: 自由記述（空欄可）
- **所属クラブ 活動拠点**: 自由記述
- **所属クラブでの役割**: 選択式（メンバー、幹事、代表者）

#### ② ビート情報（車両情報）
- **車種**: 選択式（ビート、Ver.F、Ver.C、Ver.Z、それ以外の車）
- **年式**: 選択式（'91年〜'96年）
- **車体色**: 選択式（イエロー、レッド、シルバー、ホワイト、グリーン、ブルー、エバーグレイド、その他）
- **車体色（その他の場合）**: 自由記述（「その他」選択時のみ入力可）
- **登録No.（ナンバープレート）**: 自由記述（例：品川500 あ 12-34）

#### ③ お申込内容・金額計算（自動計算）
- **基本参加（オーナー1名＋ビート1台）**: 6,000円（固定・必須）
- **ご同伴者人数（高校生以上）**: 数値入力（単価 4,000円）
- **ご同伴者人数（中学生以下）**: 数値入力（単価 600円）
- **駐車台数（追加分）**: 数値入力（単価 1,000円）
- **振込予定日**: 日付選択
- **申込日**: 送信日で自動取得

### 4.3 登録内容変更フロー（セキュリティ特化）
1. **アクセス**: メール内の変更用URLをクリック。
2. **変更画面表示**: 既存の個人情報（氏名・電話番号）は一切表示しない（空欄）。「セキュリティのため情報は表示されません。変更がない箇所も含め、全項目を再入力してください」を表示。
3. **アクション**:
   - **変更**: 入力内容でレコードを上書き更新（UPDATE）。
   - **辞退**: 下記キャンセル処理参照。
4. **制約**: ステータスが `paid`（入金済）の場合、変更・辞退は不可。

### 4.4 エラーハンドリング
- 署名付きURLの期限切れ時は専用ビュー（「有効期限切れです。トップページからやり直してください」）を表示する。

### 4.5 キャンセル（辞退）処理
- ユーザーが「辞退する」を選択した場合、`cancellation_logs` にメアドと日時を記録後、`reservations` から該当レコードを物理削除（DELETE）。サーバー上から個人情報を完全に消去する。

## 5. 機能要件（管理画面）

### 5.1 アクセス制御
- **Basic認証**: 管理画面URL（/admin等）に対し、WebサーバーレベルでのBasic認証を設定（二重ロック）。

### 5.2 機能一覧（Filament利用想定）
- **申込者一覧**: 検索（氏名、メアド）、絞り込み（ステータス別）。
- **ステータス管理**: 入金確認後、スタッフ操作で `pending` → `paid` へ変更。
- **CSVエクスポート**: Excel対応（Shift-JIS または BOM付きUTF-8）。

## 6. メール要件
- **SMTP送信**: ロリポップのメールサーバーを利用。

| メール種別 | 送信タイミング | 内容 |
|:---|:---|:---|
| 仮登録メール | フォーム送信直後 | 本登録用URL（署名付き・期限あり） |
| 完了メール | 本登録完了時 | 申し込み完了通知、振込先の案内 |
| 変更案内メール | 既登録メアド入力時 | 変更・辞退用フォームURLの通知 |

## 7. 開発ロードマップ
1. **環境構築**: ロリポップでのLaravelセットアップ、ディレクトリ分離。
2. **DB構築**: マイグレーション作成、テーブル定義。
3. **管理画面実装**: Filament導入、Basic認証設定。
4. **フロント実装**: フォーム作成、メール送信、署名付きURLの実装。
5. **例外処理実装**: エラー画面、物理削除ロジックの実装。
6. **テスト**: reCAPTCHA、メール到達、SSL確認。
