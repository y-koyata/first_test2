# イベント申し込み管理システム 仕様書

## 1. プロジェクト概要
- **プロジェクト名**: イベント申し込み管理サイト構築
- **バージョン**: 1.0 (Final)
- **作成日**: 2026/01/11
- **インフラ**: ロリポップ！レンタルサーバー（ビジネスプラン）

### 概要
一般公開されるイベントの申し込みを受け付けるWebシステム。毎年開催されるキャンペーンに対応し、**「個人情報の保護」と「不正登録の排除」**を最優先事項とする。申し込みはメールアドレスによる本人確認（ダブルオプトイン）を必須とし、既存データの変更時も個人情報を画面に表示しない「上書き方式」を採用する。

---

## 2. ユーザー種別と権限

システムを利用するユーザーは以下の2種類に大別される。

| ユーザー種別 | 概要 | 主な権限 |
|:---|:---|:---|
| **申込者（ユーザー）** | イベントへの参加を希望する一般利用者 | 新規申し込み、メール認証、申し込み内容の上書き変更、辞退 |
| **スタッフ（管理者）** | イベントの運営スタッフ | 申込データ閲覧、スタッフ管理、自アカウント更新、イベント作成、CSV出力 |

> [!IMPORTANT]
> **スタッフ権限について**: スタッフは人数が極めて少ないため、全員が特権管理者（Admin）権限を持ち、すべての機能（スタッフ追加・削除含む）にフルアクセス可能とする。

> [!CAUTION]
> **個人情報保護（上書き方式）**: セキュリティのため、いかなる場合も過去の登録内容をフォームにプレ表示させることはしない。修正・変更を希望するユーザーに対しても、常に全項目を新規入力させることで情報を上書きする。

---

## 3. 機能要件

### 3.1 申込者向け機能
- **新規申し込み**: 必須項目を入力し、仮登録を行う。
- **本人確認（ダブルオプトイン）**: 登録したメールアドレスに届くURLをクリックし、登録を確定させる。
- **申し込み内容の上書き更新**: セキュリティのため、既存の登録内容を表示させずに「すべての項目を再入力」して情報を更新する。
- **申し込み辞退**: ユーザー自身の操作により、登録情報を物理削除する。

### 3.2 スタッフ向け機能（管理画面）
- **申込者一覧・検索**: 全申込者の情報を閲覧・検索する。
- **申込者データ出力**: 外部ソフト（Excelなど）で処理可能な形式（CSV）で申込一覧を出力する。
- **スタッフ管理**: スタッフアカウントの一覧表示、新規作成、削除を行う。
- **自アカウント管理**: 自身のパスワード変更やアカウント情報の更新を行う。
- **イベント作成機能**: 新しいキャンペーン/イベントを作成する。

---

## 4. 申し込みプロセス詳細（セキュリティ特化フロー）

申し込みは以下のステップで進行する。

1. **イベントURL（GET）へのアクセス**
   - キャンペーン/イベントごとに発行された専用URLから流入。
2. **イベント説明・メールアドレス入力**
   - イベントの詳細説明や金額説明。
   - フォームでなくFAX希望の方向けにPDFをダウンロードできるボタンを用意する。
   - 申し込み（または変更）を希望するメールアドレスを入力し、送信。
3. **重複チェックと認証メール送信**
   - 入力されたemailが対象のキャンペーンに登録済みかチェック。
     - **未登録の場合**: 新規仮登録として処理。
     - **登録済の場合**: 「既存データの変更」として処理。
   - **セキュリティ徹底**: どちらの場合も、画面上には「メールを送信しました」という同一のメッセージのみを表示し、登録の有無を第三者に推測させない。
   - 30分有効な**署名付きURL**をメールで送信。
4. **本登録フォーム入力（URL認証後）**
   - メールのURLをクリックして認証。
   - **重要**: 既存登録者の場合も、個人情報漏洩防止のためフォーム内容は**一切プレ表示せず、すべて空の状態で表示**する。
   - フォームは以下の3つの大きなセクションで構成する。
     1. **申し込み前注意事項**: イベントの参加規約や注意事項、キャンセルポリシー等の確認。
     2. **基本申し込み情報**: 氏名、連絡先、車両情報、参加人数等の金額計算に直結する基本情報。
     3. **アンケート**: MTB!への参加経験、所属クラブ、役割などの追加情報。
   - 全項目を入力し、送信。
5. **登録完了（上書き保存）**
   - 既存データがある場合は最新の内容で上書き（UPDATE）。
   - ステータスを `paid`（完了）に更新し、完了メールを送信。
   - **完了メールの要件**: ユーザーが登録内容を確認できるよう、**登録されたすべての情報を箇条書きでメール本文に記載**する。

---

## 5. データベース構成

### 5.1 テーブル一覧
| テーブル名 | 役割 |
|:---|:---|
| **`campaigns`** | **イベント/キャンペーン情報**。単価設定や募集状態を管理。 |
| **`reservations`** | **申込者情報の本体**。個人情報および詳細な申込内容を保持。 |
| **`cancellation_logs`** | **辞退の証跡**。物理削除されたデータのメールアドレスと日時のみを最小限保持。 |
| **`users`** | **スタッフのアカウント管理**。管理者ログイン用。 |
| **`failed_jobs` / `jobs`** | 非同期処理（メール送信等）を安全に実行するための内部管理用。 |
| **`sessions` / `cache`** | 状態維持および高速化のための内部管理用。 |
| **`mails` (mail_logs)** | **メール送信ログ**。実際にメール送信を行わずDBに内容を保存するために使用。 |

### 5.2 詳細構成

#### campaigns (イベント・キャンペーン)
イベントごとの基本設定および単価定義。

| カラム名 | 型 | 説明 |
|:---|:---|:---|
| `id` | BIGINT | プライマリキー |
| `name` | STRING | イベント名称 |
| `slug` | STRING | URL用識別子（例: `mtb-2026`） |
| `base_fee` | INT | 基本参加料（オーナー1名+台） |
| `companion_adult_fee` | INT | 同伴者単価（大人） |
| `companion_child_fee` | INT | 同伴者単価（子供） |
| `additional_parking_fee`| INT | 追加駐車台数単価 |
| `event_date` | DATETIME | イベント開催日時 |
| `application_start_at` | DATETIME | 申し込み開始日時 |
| `application_end_at` | DATETIME | 申し込み終了日時 |
| `survey_definition` | JSON | **アンケート定義**（項目ごとのタイトル、形式、選択肢、備考を設定） |
| `status` | STRING | 募集状態（`draft`, `open`, `closed`） |
| `created_at` | DATETIME | 作成日時 |
| `updated_at` | DATETIME | 更新日時 |

#### reservations (申し込み本体)

| 分類 | カラム名 | 型 | 説明 |
|:---|:---|:---|:---|
| **管理** | `campaign_id` | UNSIGNED BIGINT | campaignテーブルへの外部キー |
| | `email` | STRING | 申込者メールアドレス（`campaign_id`とセットでユニーク） |
| **基本情報** | `name` | STRING | 氏名 |
| | `name_kana` | STRING | フリガナ |
| | `tel` | STRING | 電話番号 |
| | `zip_code` | STRING | 郵便番号 |
| | `address` | STRING | 住所 |
| | `car_model` | STRING | 車種 |
| | `car_year` | STRING | 年式 |
| | `car_registration_no` | STRING | ナンバープレート情報 |
| **申込内容** | `companion_adult_count` | INT | 同伴者人数（大人） |
| | `companion_child_count` | INT | 同伴者人数（子供） |
| | `additional_parking_count`| INT | 追加駐車台数 |
| | `transfer_date` | DATE | 振込予定日 |
| **動的項目** | **`survey_data`** | **JSON** | **アンケート内容を格納**（年度で変動する項目） |
| **日付等** | **`created_at`** | DATETIME | **登録日（作成日）** |
| | **`email_verified_at`** | DATETIME | **本人認証日** |
| | **`updated_at`** | DATETIME | **最終更新日** |
| | **`registered_at`** | **DATETIME** | **本登録日（NULLは仮登録）** |

#### cancellation_logs (辞退ログ)

| カラム名 | 型 | 説明 |
|:---|:---|:---|
| `campaign_id` | UNSIGNED BIGINT | キャンペーンID |
| `email` | STRING | 削除されたメールアドレス |
| `canceled_at` | DATETIME | 処理日時 |

#### users (スタッフ管理者)
管理画面へのログインユーザー情報。

| カラム名 | 型 | 説明 |
|:---|:---|:---|
| `id` | BIGINT | プライマリキー |
| `name` | STRING | スタッフ名 |
| `email` | STRING | メールアドレス（ログインID） |
| `password` | STRING | ハッシュ化されたパスワード |
| `remember_token`| STRING | ログイン保持用トークン |
| `created_at` | DATETIME | 作成日時 |
| `updated_at` | DATETIME | 更新日時 |

#### sessions (セッション管理)
ブラウザごとのログイン状態を保持。

| カラム名 | 型 | 説明 |
|:---|:---|:---|
| `id` | STRING | セッションID |
| `user_id` | BIGINT | ログイン中のユーザーID |
| `ip_address` | STRING | アクセス元IP |
| `user_agent` | TEXT | ブラウザ情報 |
| `payload` | LONGTEXT | セッションデータ本体 |
| `last_activity`| INT | 最終アクティビティ時間 |

#### jobs / failed_jobs (非同期処理)
メール送信などのキュー管理。

| テーブル | 説明 |
|:---|:---|
| **`jobs`** | 実行待ちのジョブ（メール送信予約等）を保持。 |
| **`failed_jobs`** | 失敗したジョブのログ（エラー内容と再試行用データ）を保持。 |
| **`job_batches`** | まとまった処理の進捗管理に使用。 |

#### mail_logs (メール送信ログ)
送信されたメールの内容を記録するテーブル（実際の送信は行わない）。

| カラム名 | 型 | 説明 |
|:---|:---|:---|
| `id` | BIGINT | プライマリキー |
| `from` | STRING | 送信元 |
| `to` | TEXT | 送信先 |
| `cc` | TEXT | CC |
| `bcc` | TEXT | BCC |
| `subject` | STRING | 件名 |
| `body` | LONGTEXT | 本文 |
| `headers` | TEXT | ヘッダー情報 |
| `created_at` | DATETIME | 送信日時 |
| `updated_at` | DATETIME | 更新日時 |

---

## 履歴
- **2026/01/11**: メール送信機能をデータベースログ方式に変更。カスタムメールドライバー `db` を実装し、`mail_logs` テーブルに送信内容を蓄積するよう変更。
- **2026/01/11**: 仮登録機能の実装。メールアドレス入力時に仮登録データ（`registered_at`がNULL）を作成し、本登録完了時に日時を記録するよう変更。また、仮登録状態で再申し込みがあった場合は新規データとして扱うよう改修。
- **2026/01/11**: 管理画面のキャンペーン一覧機能強化。ステータスの詳細表示（下書き、期間外、受付中、終了）と申し込み人数の表示を追加。また、申し込み詳細一覧へのリンクを設置し、申し込み情報のCSV/Excel出力機能を実装。
- **2026/01/11**: 管理画面UIの改善。「イベント編集画面」と「申し込み情報画面」を分離。サブナビゲーションを導入し、イベントごとのタブ切り替え（編集 / 申し込み一覧）で管理できるように変更。
- **2026/01/12**: キャンペーン一覧ページ（申し込み開始ページ）のデザインをリニューアル。Tailwind CSSを使用し、ヒーローエリア、イベント概要、申し込み手順（ステップ表示）を実装。メール認証フォームの表示/非表示切り替え機能を追加。
